<ng-template #loading>
  <app-loading></app-loading>
</ng-template>

<div *ngIf="user; else loading">
  <h2 class="text-3xl mb-5 font-bold">
    {{ user.firstname }} {{ user.lastname }}
  </h2>

  <div class="tabs mb-5 grid justify-items-center lg:justify-items-start">
    <div>
      <a
        class="tab tab-lg tab-bordered"
        [ngClass]="{ 'tab-active': activeTab.info }"
        (click)="activateTab('info')"
        >Info</a
      >
      <a
        class="tab tab-lg tab-bordered"
        [ngClass]="{ 'tab-active': activeTab.dpms }"
        (click)="activateTab('dpms')"
        >DPMs</a
      >
      <a
        class="tab tab-lg tab-bordered"
        [ngClass]="{ 'tab-active': activeTab.actions }"
        (click)="activateTab('actions')"
        >Actions</a
      >
    </div>
  </div>

  <div *ngIf="activeTab.info">
    <form
      class="grid grid-cols-3 gap-x-6 gap-y-2 rounded"
      [formGroup]="userFormGroup"
      (ngSubmit)="onSubmit()"
    >
      <div class="form-control col-span-3 md:col-span-1">
        <label class="label" for="userEmail">
          <span
            class="label-text"
            [ngClass]="{ 'text-error': hasErrors(email) }"
            >Email
          </span>
        </label>

        <input
          id="userEmail"
          type="text"
          placeholder="dpm@utsdpm.com"
          class="input input-bordered"
          formControlName="email"
          autocomplete="off"
          required
          [ngClass]="{ 'input-error': hasErrors(email) }"
        />

        <label class="label" for="userEmail">
          <span class="label-text-alt text-error">
            {{ getEmailValidationMessages() }}
          </span>
        </label>
      </div>

      <div class="form-control col-span-3 md:col-span-1">
        <label class="label" for="firstname">
          <span
            class="label-text"
            [ngClass]="{ 'text-error': hasErrors(firstname) }"
            >First Name
          </span>
        </label>

        <input
          id="firstname"
          type="text"
          placeholder="Jane"
          class="input input-bordered"
          formControlName="firstname"
          autocomplete="off"
          required
          [ngClass]="{ 'input-error': hasErrors(firstname) }"
        />

        <label class="label" for="firstname">
          <span class="label-text-alt text-error">
            {{ getFirstnameValidationMessages() }}
          </span>
        </label>
      </div>

      <div class="form-control col-span-3 md:col-span-1">
        <label class="label" for="lastname">
          <span
            class="label-text"
            [ngClass]="{ 'text-error': hasErrors(lastname) }"
            >Last Name
          </span>
        </label>

        <input
          id="lastname"
          type="text"
          placeholder="Doe"
          class="input input-bordered"
          formControlName="lastname"
          autocomplete="off"
          [ngClass]="{ 'input-error': hasErrors(lastname) }"
          required
        />

        <label class="label" for="lastname">
          <span class="label-text-alt text-error">
            {{ getLastnameValidationMessages() }}
          </span>
        </label>
      </div>

      <div class="form-control col-span-3 md:col-span-1">
        <label class="label" for="points">
          <span
            class="label-text"
            [ngClass]="{ 'text-error': hasErrors(points) }"
            >Points</span
          >
        </label>

        <input
          id="points"
          type="text"
          placeholder="0"
          class="input input-bordered"
          formControlName="points"
          autocomplete="off"
          required
          [ngClass]="{ 'input-error': hasErrors(points) }"
        />

        <label class="label" for="points">
          <span class="label-text-alt text-error">
            {{ getPointsValidationMessages() }}
          </span>
        </label>
      </div>

      <div class="form-control col-span-3 md:col-span-1">
        <label class="label" for="role-select">
          <span class="label-text">Manager</span>
        </label>

        <select
          id="manager-select"
          class="select select-bordered w-full"
          formControlName="manager"
        >
          <option *ngFor="let manager of managers" [value]="manager">
            {{ manager }}
          </option>
        </select>

        <label class="label" for="manager-select">
          <span class="label-text-alt">
            <!-- Spacing -->
          </span>
        </label>
      </div>

      <div class="form-control col-span-3 md:col-span-1">
        <label class="label" for="role-select">
          <span class="label-text">Role</span>
        </label>

        <select
          id="role-select"
          class="select select-bordered w-full"
          formControlName="role"
        >
          <option *ngFor="let role of roles" [value]="role">
            {{ role }}
          </option>
        </select>

        <label class="label" for="role-select">
          <span class="label-text-alt">
            <!-- Spacing -->
          </span>
        </label>
      </div>

      <div class="grid col-span-3 justify-items-center items-start">
        <div class="form-control align-top">
          <label
            class="label cursor-pointer justify-center lg:justify-start items-center"
          >
            <span class="text-base mr-6">Full Time</span>
            <input
              type="checkbox"
              class="checkbox checkbox-md"
              formControlName="fullTime"
            />
          </label>
        </div>
      </div>

      <div class="grid place-items-center col-span-3 mt-2">
        <button
          pRipple
          type="submit"
          class="btn btn-secondary m-auto w-full md:btn-wide"
          [disabled]="!userFormGroup.valid || userFormGroup.pristine"
        >
          Update
        </button>
      </div>
    </form>
  </div>

  <div *ngIf="activeTab.dpms">
    <p-table
      #dt
      [value]="dpms"
      dataKey="id"
      styleClass="table table-fixed lg:table-auto w-full"
      [rowHover]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      [rowsPerPageOptions]="[10, 25, 50]"
      [loading]="loadingDpms"
      responsiveLayout="scroll"
      [paginator]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      [lazy]="true"
      [totalRecords]="totalRecords"
      (onLazyLoad)="lazyLoadEvent($event)"
    >
      <ng-template pTemplate="header" class="table">
        <tr>
          <th class="lg:text-base break-words">Type</th>
          <th class="lg:text-base break-words">Date</th>
          <th class="lg:text-base break-words">Status</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-dpm>
        <tr class="hover hover:cursor-pointer" (click)="clickRow(dpm)">
          <td class="break-words whitespace-normal">
            {{ dpm.type }}
          </td>
          <td class="break-words whitespace-normal">
            {{ dpm.date }}
          </td>
          <td class="break-words whitespace-normal">
            {{ dpm.status }}
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8">No dpms found.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <div *ngIf="activeTab.actions">
    <div class="grid grid-cols-2 place-items-center">
      <div class="col-span-2 md:col-span-1 md:justify-self-end md:mr-5">
        <a class="link link-hover text-lg">Send Points Email</a>
      </div>
      <div class="col-span-2 md:col-span-1 md:justify-self-start md:ml-5">
        <a class="link link-hover text-lg text-error">Delete User</a>
      </div>
    </div>
  </div>
</div>

<input
  type="checkbox"
  id="dpmModal"
  class="modal-toggle"
  [(ngModel)]="modalOpen"
/>
<label for="dpmModal" class="modal cursor-pointer">
  <label class="modal-box relative">
    <div *ngIf="currentDpm">
      <h3 class="text-xl font-bold mx-4">{{ currentDpm.type }}</h3>

      <table
        class="my-2 md:my-4 border-separate border-spacing-x-2 md:border-spacing-x-4 border-spacing-y-1.5 table-auto"
      >
        <tbody class="text-left align-text-top">
          <tr *ngIf="currentDpm.createdBy" class="whitespace-nowrap">
            <th>Created By:</th>
            <td>{{ currentDpm.createdBy }}</td>
          </tr>

          <tr>
            <th>Points:</th>
            <td>{{ currentDpm.points | points }}</td>
          </tr>

          <tr>
            <th>Block:</th>
            <td>{{ currentDpm.block | block }}</td>
          </tr>

          <tr>
            <th>Location:</th>
            <td>{{ currentDpm.location | uppercase }}</td>
          </tr>

          <tr>
            <th>Date:</th>
            <td>{{ currentDpm.date }}</td>
          </tr>

          <tr>
            <th>Time:</th>
            <td>
              {{ currentDpm.time }}
            </td>
          </tr>

          <tr>
            <th>Created At:</th>
            <td>{{ currentDpm.createdAt }}</td>
          </tr>

          <tr *ngIf="currentDpm.notes" class="break-words whitespace-normal">
            <th>Notes:</th>
            <td>{{ currentDpm.notes }}</td>
          </tr>

          <tr>
            <th>Status:</th>
            <td>{{ currentDpm.status }}</td>
          </tr>
        </tbody>
      </table>

      <div class="modal-action">
        <label
          pRipple
          for="dpmModal"
          class="btn btn-outline"
          (click)="denyDpm()"
          [ngClass]="{
            'btn-error': !currentDpm.ignored,
            'btn-disabled': currentDpm.ignored
          }"
          >Deny</label
        >
      </div>
    </div>
  </label>
</label>
